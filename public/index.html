<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Live Stream (auto)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    video { width: 90%; max-width: 640px; border: 2px solid #444; border-radius: 8px; display:block; margin-bottom:10px; }
    #status { margin-top: 8px; }
  </style>
</head>
<body>
  <h1>🎥 Live & opname gestart...</h1>
  <video id="local" autoplay playsinline muted></video>
  <div id="status"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const localVideo = document.getElementById("local");
    const statusEl = document.getElementById("status");

    let pc;
    let mediaRecorder;
    let recordedChunks = [];
    let liveStream;

    function setStatus(msg) { statusEl.textContent = msg; }

    async function startEverything() {
      try {
        liveStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: true
        });
        localVideo.srcObject = liveStream;

        // WebRTC live
        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });
        liveStream.getTracks().forEach(t => pc.addTrack(t, liveStream));
        pc.onicecandidate = e => { if (e.candidate) socket.emit("ice-candidate", e.candidate); };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("offer", offer);

        socket.on("answer", async (answer) => {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });
        socket.on("ice-candidate", async (candidate) => {
          try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { console.error(e); }
        });

        // Opname
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(liveStream, { mimeType: "video/webm" });
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = uploadRecording;
        mediaRecorder.start();

        setStatus("⏺ Live & opname gestart automatisch");
      } catch (err) {
        console.error(err);
        setStatus("❌ Kon camera/microfoon niet starten: " + err.message);
      }
    }

    async function uploadRecording() {
      try {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedChunks = [];
        const form = new FormData();
        form.append("recording", blob, "opname.webm");
        form.append("title", "auto");
        setStatus("⏳ Uploaden...");
        const res = await fetch("/upload-recording", { method: "POST", body: form });
        if (!res.ok) throw new Error(await res.text());
        setStatus("✅ Opname geüpload. Terug te zien op /videos5713");
      } catch (err) {
        console.error(err);
        setStatus("❌ Upload mislukt: " + err.message);
      }
    }

    // Stop automatisch als gebruiker site sluit
    window.addEventListener("beforeunload", () => {
      try {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
        if (pc) { pc.close(); }
        if (liveStream) { liveStream.getTracks().forEach(t => t.stop()); }
      } catch (_) {}
    });

    // 🚀 Direct starten bij laden
    startEverything();
  </script>
</body>
</html>
